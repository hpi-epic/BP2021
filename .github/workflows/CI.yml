name: CI

on: push

jobs:
  build-linux:
    runs-on: [self-hosted, ubuntu-20.04]
    name: CI on Ubuntu
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install AlphaBusiness package
        shell: bash -l {0}
        run: |
          pip install -e ./src
      - name: Pre-commit
        shell: bash -l {0}
        run: |
          git init
          git add .
          pre-commit install
          pre-commit run --all-files
          rm -rf .git
      - name: Pytest
        shell: bash -l {0}
        run: |
          coverage run --source=./src -m pytest
      - name: Report Coverage
        shell: bash -l {0}
        run: |
          coverage report
      - name: "OnError: Test with pytest (verbose)"
        if: failure()
        shell: bash -l {0}
        run:  |
          pytest -v

# This is the old version of the CI, we are keeping it in case we need to use it again
# name: CI

# on: push

# # using setup-miniconda from https://github.com/conda-incubator/setup-miniconda

# jobs:
#   build:
#     runs-on: [self-hosted, ubuntu-20.04]
#     name: CI on Ubuntu
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
#       - name: Setup Miniconda
#         uses: conda-incubator/setup-miniconda@v2
#         with:
#           miniconda-version: "latest"
#           auto-update-conda: true
#           environment-file: environment.yml
#       - name: Lint using Pre-commit
#         uses: pre-commit/action@v2.0.3
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#       - name: Pytest
#         shell: bash -l {0}
#         run: coverage run --source=./src -m pytest
#       - name: Report Coverage
#         shell: bash -l {0}
#         run: coverage report
#       - name: "OnError: Test with pytest (verbose)"
#         if: failure()
#         shell: bash -l {0}
#         run: pytest -v
